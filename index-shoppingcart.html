<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>食趣 - 一人的食材外送</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet"
        type="text/css">

    <!-- Custom styles for this template -->
    <link href="css/landing-page.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/shoppingcart.css">

    <!-- airtable -->
    <script src="https://code.jquery.com/jquery-1.12.2.min.js"></script>
    <script src="node_modules/airtable/build/airtable.browser.js"></script>

</head>

<body>

    <!--Navigation-->

    <header id="header-1" class="header">
        <nav class="header-nav">
            <a href="index.html">
                <img class="logo" src="img/logo.png">
            </a>
            <div class="search-button">
                <i class="fas fa-search search-toggle" data-selector="#header-1"></i>
            </div>
            <ul class="menu">
                <li><a href="index-search.html">食譜</a></li>
                <li><a href="#">會員專區</a></li>

                <li><a href="index-shoppingcart.html">購物車</a></li>
                <li><a href="index-login.html">Sign In</a></li>
            </ul>
            <div class="float-right">
                <form action="" class="search-box">
                    <input type="text" class="text search-input" placeholder="Type here to search..." />
                </form>
            </div>
        </nav>
    </header>

    <!--    Shoppingcart-->
    <div class="container1">
        <div class="row">
            <div class="col-md-6 bg-white">
                <h4 class="title">購物車</h4>
                <hr>
                <div class="col-md-12" id="contains">
                    <!--
                    <table class="table table-sm goods-text">        
                        <tr>
                            <td rowspan="4" width="240px"><img class="goods" src="img/food3.jpg"></td>
                            <td class="goods-price">$168</td>
                        </tr>
                        <tr align="left">
                            <td>黃金炸豬排</td>
                        </tr>
                        <tr>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>數量：</td>
                            <td>
                                <select class="browser-default custom-select">
                                    <option selected value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </td>
                        </tr>
                    </table>
-->
                </div>
                <!--<<div class="col-md-12">-->
                <hr>
            </div>
            <!--<div class="col-md-6 bg-white">-->
            <div class="col-md-4 bg-white shop-check" id="total">
                <!--
                <h4 class="title">總額</h4>
                <hr>
                <p class="checkout">商品總價：$872</p>
                <p class="checkout">運費：$100</p>
                <br>
                <hr>
                <p class="checkout">我們接受：</p>
                <img class="creditcard" src="https://www.patriotfamilydental.com/wp-content/uploads/2016/08/accepted-creditcards.png">
                <button type="submit" class="btn btn-cart">
                    <a href="#" class="color-wt">結帳</a>
                </button>
-->
            </div>
        </div>
        <!--<div class="row">-->

        <!-- Footer -->
        <footer class="footer bg-light">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 h-100 text-center text-lg-left my-auto">
                        <ul class="list-inline mb-2">
                            <li class="list-inline-item">
                                <a class="info-text" href="#">About</a>
                            </li>
                            <li class="list-inline-item">&sdot;</li>
                            <li class="list-inline-item">
                                <a class="info-text" href="#">Contact</a>
                            </li>
                            <li class="list-inline-item">&sdot;</li>
                            <li class="list-inline-item">
                                <a class="info-text" href="#">Terms of Use</a>
                            </li>
                            <li class="list-inline-item">&sdot;</li>
                            <li class="list-inline-item">
                                <a href="#" class="info-text">Privacy Policy</a>
                            </li>
                        </ul>
                        <p class="text-muted small mb-4 mb-lg-0">&copy; Your Website 2019. All Rights Reserved.</p>
                    </div>
                    <div class="col-lg-6 h-100 text-center text-lg-right my-auto">
                        <ul class="list-inline mb-0">
                            <li class="list-inline-item mr-3">
                                <a class="info-text" href="#">
                                    <i class="fab fa-facebook fa-2x fa-fw"></i>
                                </a>
                            </li>
                            <li class="list-inline-item mr-3">
                                <a class="info-text" href="#">
                                    <i class="fab fa-twitter-square fa-2x fa-fw"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a class="info-text" href="#">
                                    <i class="fab fa-instagram fa-2x fa-fw"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Bootstrap core JavaScript -->
        <script src="vendor/jquery/jquery.min.js"></script>
        <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

        <script src="js/index.js"></script>
    </div>
    <!--<div class="container1">-->
</body>
<script>
    var Airtable = require('airtable');
    var base = new Airtable({
        apiKey: 'keyabYPbrYnSWmK9v'
    }).base('appZpGVmdenKv27KK');
    const url = new URL(window.location.href);
    const id = url.searchParams.get("id");
    //console.log(id);

    function Add(node) {
        var inputs = node.parentNode.getElementsByTagName("input");
        var a = new Number(inputs[1].value);
        a = a + 1;
        inputs[1].value = "" + a;
        var idd = node.parentNode.getElementsByTagName("input")[1].name;
        base('Shoppingcart').select({
            view: "Grid view"
        }).eachPage(function page(shoppingcarts, fetchNextPage) {
            console.log("shoppingcarts: ", shoppingcarts);
            for (var i in shoppingcarts) {
                //console.log(shoppingcarts[i]);
                if (idd === shoppingcarts[i].id) {
                    base('Shoppingcart').update(idd, {
                        "Shop_amount": shoppingcarts[i].fields.Shop_amount + 1,
                    }, function (err, record) {
                        if (err) {
                            console.error(err);
                            return;
                        }
                        console.log(record.get('Shop_amount'));
                        window.location.replace("index-shoppingcart.html")
                    });
                }
            }
        });
    }

    function Sub(node) { //node.parentNode的类型为单元格

        var inputs = node.parentNode.getElementsByTagName("input");
        var a = new Number(inputs[1].value);
        a = a - 1;
        inputs[1].value = inputs[1].value - 1;
        var idd = node.parentNode.getElementsByTagName("input")[1].name;
        base('Shoppingcart').select({
            view: "Grid view"
        }).eachPage(function page(shoppingcarts, fetchNextPage) {
            console.log("shoppingcarts: ", shoppingcarts);
            for (var i in shoppingcarts) {
                //console.log(shoppingcarts[i]);
                if (idd === shoppingcarts[i].id) {
                    base('Shoppingcart').update(idd, {
                        "Shop_amount": shoppingcarts[i].fields.Shop_amount - 1,
                    }, function (err, record) {
                        if (err) {
                            console.error(err);
                            return;
                        }
                        console.log(record.get('Shop_amount'));
                        window.location.replace("index-shoppingcart.html")
                    });
                }
            }
        });
    }

    base('Shoppingcart').select({
        view: "Grid view"
    }).eachPage(function page(shoppingcarts, fetchNextPage) {
        console.log("shoppingcarts: ", shoppingcarts);
        var c = 0;
        for (var i in shoppingcarts) {
            //console.log(shoppingcarts[i]);
            if (id === shoppingcarts[i].fields.name[0]) {
                base('Shoppingcart').update(shoppingcarts[i].id, {
                    "Shop_amount": shoppingcarts[i].fields.Shop_amount + 1,
                }, function (err, record) {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    console.log(record.get('Shop_amount'));
                    window.location.replace("index-shoppingcart.html")
                });
                c += 1;
            }
        }
        if (c === 0) {
            if (id !== null) {
                base('Shoppingcart').create({
                    "Shop_amount": 1,
                    "name": [id]
                }, function (err, record) {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    console.log(record.getId());
                    window.location.replace("index-shoppingcart.html")
                });
                console.log("c", c);
            }
        }
        base('Product').select({
            view: "Grid view"
        }).eachPage(function page(products, fetchNextPage) {
            console.log("products: ", products);
            var sumeach;
            var sumall = 0;
            for (var i in shoppingcarts) {
                for (var j in products) {
                    if (products[j].id === shoppingcarts[i].fields.name[0]) {
                        sumall += products[j].fields.Pro_price * shoppingcarts[i].fields.Shop_amount;
                        $('#contains').append(
                            `
                          <table class="table table-borderless table-sm goods-text " align="">
                                <tr>
                                    <td rowspan="4"  width="240px"><img class="goods" src="${products[j].fields.Pro_image}"></td>
                                    <td class="goods-price">$${products[j].fields.Pro_price}</td>
                                    
                                    <td align="right"><a href="index-shoppingcartdel.html?id=${shoppingcarts[i].id}" style="color:#6FA09E" ><buttom class="fas fa-trash-alt" ></buttom></a></td>

                                </tr>
                                <tr>
                                    <td>${products[j].fields.Pro_name}</td>
                                </tr>
                                <tr>
                                    <td>小計：</td>
                                    <td class="browser-default">$${products[j].fields.Pro_price*shoppingcarts[i].fields.Shop_amount}</td>
                                </tr>
                                <tr>
                                    <td>數量:</td>
                                    <td>                                       
                                        <input value="-" type="button" onclick="Sub(this)">
                                        ${shoppingcarts[i].fields.Shop_amount}
                                        <input type="hidden" value=${shoppingcarts[i].fields.Shop_amount} name=${shoppingcarts[i].id} size="1">
                                        <input value="+" type="button" onclick="Add(this)">
                                    </td>
                                </tr>
                            </table>
                          `
                        );
                    }
                }
            }
            console.log(sumall);
            $("#total").append(
                `
                <h4 class="title">總額</h4>
                <hr>
                <p class="checkout">商品總價：$${sumall}</p>
                <p class="checkout">運費：$100</p>
                <p class="checkout">共計：$${sumall+100}</p>
                <br>
                <hr>
                <p class="checkout">我們接受：</p>
                <img class="creditcard" src="https://www.patriotfamilydental.com/wp-content/uploads/2016/08/accepted-creditcards.png">
                <button type="submit" class="btn btn-cart">
                <a href="#" class="color-wt">結帳</a>
                </button>
                `
            );
        });
    });
</script>

</html>