<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>食趣 - 一人的食材外送</title>
</head>
<!-- Bootstrap core CSS -->
<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

<!-- Custom fonts for this template -->
<link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
<link href="vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet"
    type="text/css">

<!-- Custom styles for this template -->
<link href="css/landing-page.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/creditcard.css">
<link rel="stylesheet" href="css/style-card.css">

<!-- airtable -->
<script src="https://code.jquery.com/jquery-1.12.2.min.js"></script>
<script src="node_modules/airtable/build/airtable.browser.js"></script>


<body>
    <!--Navigation-->
    <header id="header-1" class="header">
        <nav class="header-nav">
            <a href="index.html">
                <img class="logo" src="img/logo.png">
            </a>

            <ul class="menu">
                <li><a href="index-search.html">食譜</a></li>
                <li><a href="#">會員專區</a></li>

                <li><a href="index-shoppingcart.html">購物車</a></li>
                <li><a href="index-login.html">Sign In</a></li>
            </ul>
            <div class="float-right">
            </div>
        </nav>
    </header>

    <div class="container3">
        <div class="row">
            <div class="bgcolor">
                <div class="head">
                    收貨人資料
                </div>
                <div id="detail">
                    <!--
                     <table class="table info">
                        <tbody>
                            <tr>
                                <td></td>
                            </tr>
                            <tr>
                                <td>地址：新北市新莊區後港一路127號</td>
                            </tr>
                            <tr>
                                <td>聯絡電話：0963985025</td>
                            </tr>
                            <tr>
                                <td>配送時間：10:00 ~ 11:00</td>
                            </tr>
                            <tr>
                                <td>配送日期：08/22</td>
                            </tr>

                        </tbody>
                    </table> 
-->
                </div>

            </div>
            <div class="bgcolor">
                <div class="head">
                    明細顯示
                </div>
                <br>
                <div id="detail2" align="left">
                    <!--
                     <table class="table table-sm goods-text table-borderless">
                        <tr>
                        
                        </tr>
                        <tr align="left" width="px">
                            <td>黃金炸豬排</td>
                        </tr>

                        <tr>
                            <td>數量：1</td>

                        </tr>
                    </table>
-->



                </div>
                <div id="detali3">
                    <!-- <p class="total">運費：100 &nbsp; 小計：180</p>
                    <p class="total">總價：280</p>
                    <br><br><br> -->
                </div>




            </div>
            <div class="bgcolor">
                <div class="head">
                    輸入信用卡資料
                </div>

                <form>
                    <div class="form-container">

                        <input id="column-left" type="text" name="first-name" placeholder="First Name" />
                        <input id="column-right" type="text" name="last-name" placeholder="Surname" />
                        <input id="input-field" type="text" name="number" placeholder="Card Number" />
                        <input id="column-left" type="text" name="expiry" placeholder="MM / YY" />
                        <input id="column-right" type="text" name="cvc" placeholder="CCV" />

                        <div class="card-wrapper"></div>

                    </div>

                </form>
                <div align="right"><button class="btn btn-card" type="submit" onclick="main()">確認</button></div>


            </div>



        </div>
    </div>

    <!-- Footer -->
    <footer class="footer bg-light">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 h-100 text-center text-lg-left my-auto">
                    <ul class="list-inline mb-2">
                        <li class="list-inline-item">
                            <a class="info-text" href="#">About</a>
                        </li>
                        <li class="list-inline-item">&sdot;</li>
                        <li class="list-inline-item">
                            <a class="info-text" href="#">Contact</a>
                        </li>
                        <li class="list-inline-item">&sdot;</li>
                        <li class="list-inline-item">
                            <a class="info-text" href="#">Terms of Use</a>
                        </li>
                        <li class="list-inline-item">&sdot;</li>
                        <li class="list-inline-item">
                            <a href="#" class="info-text">Privacy Policy</a>
                        </li>
                    </ul>
                    <p class="text-muted small mb-4 mb-lg-0">&copy; Your Website 2019. All Rights Reserved.</p>
                </div>
                <div class="col-lg-6 h-100 text-center text-lg-right my-auto">
                    <ul class="list-inline mb-0">
                        <li class="list-inline-item mr-3">
                            <a class="info-text" href="#">
                                <i class="fab fa-facebook fa-2x fa-fw"></i>
                            </a>
                        </li>
                        <li class="list-inline-item mr-3">
                            <a class="info-text" href="#">
                                <i class="fab fa-twitter-square fa-2x fa-fw"></i>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a class="info-text" href="#">
                                <i class="fab fa-instagram fa-2x fa-fw"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

</body>
<script>
    const url = window.location.search;
    if (url.indexOf("?") != -1) {
        result = url.substr(url.indexOf("=") + 1);
        result = decodeURI(decodeURI(result));
        var detail = result.split("&");
        console.log(detail);
        //總價
        var sumall = 0;
        var subtotal = [];
        //處理時間
        // var parts = detail[3].split('-');
        // var mydate = new Date(parts[0], parts[1] - 1, parts[2]);
        // console.log(mydate);
        //抓收貨人資料

        $('#detail').append(`
            <br>
            <table class="table info">
                        <tr>
                            <td>姓名：${detail[0]}</td>
                            <input type="hidden" id="name" value="${detail[0]}">
                        </tr>
                        <tr>
                            <td>地址：${detail[5]+detail[6]+detail[7]}</td>
                            <input type="hidden" id="city" value="${detail[5]}">
                            <input type="hidden" id="district" value="${detail[6]}">
                            <input type="hidden" id="address" value="${detail[7]}">
                        </tr>
                        <tr>
                            <td>聯絡電話：${detail[1]}</td>
                            <input type="hidden" id="phone" value="${detail[1]}">
                        </tr>
                        <tr>
                            <td>配送時間：${detail[4]}</td>
                        </tr>
                        <tr>
                            <td>配送日期：${detail[3]}</td>
                            <input type="hidden"  id="produce_date" value="${detail[3]}">
                        </tr>
                        <tr>
                            <td>配送方式：${detail[2]}</td>
                        </tr>
                        <tr>
                            <td>注意事項：${detail[8]}</td>
                        </tr>
                        


            </table>

        `);
        //抓明細顯示
        var Airtable = require('airtable');
        var base = new Airtable({
            apiKey: 'keyabYPbrYnSWmK9v'
        }).base('appZpGVmdenKv27KK');

        base('Shoppingcart').select({
            view: "Grid view"
        }).eachPage(function page(shoppingcarts, fetchNextPage) {
            base('Product').select({
                view: "Grid view"
            }).eachPage(function page(products, fetchNextPage) {
                //console.log("products: ", products);
                var sumeach;

                for (var i in shoppingcarts) {
                    for (var j in products) {
                        if (products[j].id === shoppingcarts[i].fields.name[0]) {
                            sumall += products[j].fields.Pro_price * shoppingcarts[i].fields
                                .Shop_amount;
                            subtotal.push(products[j].fields.Pro_price * shoppingcarts[i].fields
                                .Shop_amount);

                            $('#detail2').append(`
                                <table class="table table-sm goods-text table-borderless">
                                <tr>
                                    <td rowspan="4" width="170px"><img class="goods" src="${products[j].fields.Pro_image}"></td>
                                    <td class="goods-price">$${products[j].fields.Pro_price}</td>
                                </tr>
                                <tr align="left">
                                    <td>${products[j].fields.Pro_name}</td>
                                </tr>

                                <tr>
                                    <td>數量：${shoppingcarts[i].fields.Shop_amount}</td>
                                </tr>

                                </tr>
                                <tr>
                                <td>小計：$${products[j].fields.Pro_price*shoppingcarts[i].fields.Shop_amount}</td>
                                </tr>
                                </table>
                                <hr>
                            `);
                        }
                    }
                }

                console.log(subtotal);
                $("#detail2").append(
                    `
                    <p class="total">運費：100</p>
                    <p class="total">商品總價：$${sumall}</p>
                    <p class="total">總價：$${sumall+100}</p>
                    <br><br><br>
                    `
                );


            });
        });
    };

    function main() {
        //first:增加OrderDetail
        //add1();

        //OKKKK
        //second:增加Order&&客戶資料
        add_cus();
        //forth:清空資料庫啦啦啦啦啦啦啦啦啦啦
        //clear(); OKKKK  
    };

    //新增oderdetail
    // function add1() {
    //     //base('Shoppingcart')
    //     base('Product').select({
    //         view: "Grid view"
    //     }).eachPage(function page(pro, fetchNextPage) {
    //         base('Shoppingcart').select({
    //             view: "Grid view"
    //         }).eachPage(function page(records, fetchNextPage) {
    //             console.log(records);
    //             for (var i in records) {
    //                 base('Orderdetails').create({
    //                     //"Order_id":[******]
    //                     "Pro_id": [records[i].fields.name[0]],
    //                     "Ordered_quantity": records[i].fields.Shop_amount,
    //                     //"Pro_produce_date": document.getElementById("produce_date").value,
    //                     //"Pro_expire_date": "2019-05-03"
    //                 }, function (err, record) {
    //                     if (err) {
    //                         console.error(err);
    //                         return;
    //                     }
    //                     console.log(record.getId());
    //                     OD_id.push(record.getId());

    //                 });
    //             }
    //             fetchNextPage();
    //         }, function done(err) {
    //             if (err) {
    //                 console.error(err);
    //                 return;
    //             }
    //         });

    //         fetchNextPage();
    //     }, function done(err) {
    //         if (err) {
    //             console.error(err);
    //             return;
    //         }
    //     });
    // }



    //新增custer&&oder
    function add_cus() {
        console.log(document.getElementById("name").value);
        base('Customer').create({
            //"Cus_email": "jerry@gmail.com",
            //"Cus_password": "jerryyyyyyy",
            "Cus_name": document.getElementById("name").value,

            //"Cus_gender": "男",
            "Cus_city": document.getElementById("city").value,
            "Cus_district": document.getElementById("district").value,
            "Cus_address": document.getElementById("address").value,
            "Cus_phone": document.getElementById("phone").value

        }, function (err, cus_record) {
            if (err) {
                console.error(err);
                return;
            }
            console.log(cus_record.getId());
            var Oder_id = cus_record.getId();
            var d = new Date();
            var n = d.toISOString();
            var n2 = detail[3].concat("T", detail[4], ":00.000Z");
            base('Order').create({
                "Order_time": n,
                "Required_time": n2,
                // "Shipped_time": "2019-05-02T08:40:00.000Z",
                "Order_status": "已付款",
                "Cus_id": [
                    Oder_id
                ],
                "Price_total": sumall,
                // "Orderdetails": OD_id
            }, function (err, order_record) {
                if (err) {
                    console.error(err);
                    return;
                }
                console.log(order_record.getId());
                var cart_id = order_record.getId();


        //找到table---product
        base('Product').select({
            view: "Grid view"
        }).eachPage(function page(pro, fetchNextPage) {
            //找到table---shoppingcart
            console.log(pro);
            var pd = [];
            base('Shoppingcart').select({
                view: "Grid view"
            }).eachPage(function page(records, fetchNextPage) {
                records.forEach(function (sc, i) {
                    var shopcart = sc.fields.name[0];
                    pro.forEach(function (pc, j) {
                        if (shopcart === pc.id) {
                            pd.push(pc.fields.Pro_expire_day);
                        }
                    });
                });
                console.log(pd);
                var pd_after = [];
                for (var i in pd) {
                    var pd_before = detail[3];
                    console.log(detail[3]);
                    var d1 = new Date(detail[3]);
                    var d2 = new Date(d1);
                    d2.setDate(d2.getDate() + pd[i]);
                    console.log(d2);
                    pd_after.push(d2.toISOString().substr(0,10));
                    console.log(pd_after);
                }
                
                for (var i in records) {
                    base('Orderdetails').create({
                        "Order_id": [cart_id],
                        "Pro_id": [records[i].fields.name[0]],
                        "Ordered_quantity": records[i].fields
                            .Shop_amount,
                        "Price_subtotal": subtotal[i],
                        "Pro_produce_date": detail[3],
                        "Pro_expire_date": pd_after[i]
                    }, function (err, record) {
                        if (err) {
                            console.error(err);
                            return;
                        }
                        console.log(record.getId());
                    });

                }




                fetchNextPage();
            }, function done(err) {
                if (err) {
                    console.error(err);
                    return;
                }
            });

            fetchNextPage();
        }, function done(err) {
            if (err) {
                console.error(err);
                return;
            }
        });



            });
        });
    }

    function clear() {
        base('Shoppingcart').select({
            //maxRecords: 1,
            view: "Grid view"
        }).eachPage(function page(records, fetchNextPage) {
            records.forEach(function (record) {
                //var id = record.get('Shop_id');
                console.log(record.id);
                clear2(record.id);
            });
            fetchNextPage();
        }, function done(err) {
            if (err) {
                console.error(err);
                return;
            }

        });

    }

    function clear2(id) {
        base('Shoppingcart').destroy(id, function (err, deletedRecords) {
            if (err) {
                console.error(err);
                return;
            }
            console.log('Deleted record', deletedRecord.id);
        });
    }
</script>
<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='https://s3-us-west-2.amazonaws.com/s.cdpn.io/121761/card.js'></script>
<script src='https://s3-us-west-2.amazonaws.com/s.cdpn.io/121761/jquery.card.js'></script>



<script src="js/index-card.js"></script>

</html>